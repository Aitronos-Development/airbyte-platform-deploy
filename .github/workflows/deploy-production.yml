name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'ingress/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Connectors Platform to Production
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/828187884021/locations/global/workloadIdentityPools/github-actions/providers/github'
          service_account: 'github-actions-production@airbyte-backend-production.iam.gserviceaccount.com'
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'
      
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials airbyte-prod-gke \
            --region europe-west6 \
            --project airbyte-backend-production
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'
      
      - name: Add Airbyte Helm repo
        run: |
          helm repo add airbyte https://airbytehq.github.io/helm-charts
          helm repo update
      
      - name: Create Kubernetes namespace and service account
        run: |
          kubectl create namespace airbyte --dry-run=client -o yaml | kubectl apply --validate=false -f -
          kubectl create serviceaccount airbyte-admin -n airbyte --dry-run=client -o yaml | kubectl apply --validate=false -f -
          kubectl annotate serviceaccount airbyte-admin -n airbyte \
            iam.gke.io/gcp-service-account=airbyte-prod-airbyte-sa@airbyte-backend-production.iam.gserviceaccount.com \
            --overwrite
      
      - name: Deploy Airbyte with Helm
        run: |
          helm upgrade --install airbyte airbyte/airbyte \
            --version 0.49.24 \
            -n airbyte \
            -f helm/values-prod-minimal.yaml \
            --wait \
            --timeout 15m
      
      - name: Apply Ingress
        run: |
          kubectl apply --validate=false -f ingress/iap-backend-config.yaml
          kubectl apply --validate=false -f ingress/dual-domain-ingress-prod.yaml
      
      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/airbyte-server -n airbyte --timeout=10m
          kubectl rollout status deployment/airbyte-webapp -n airbyte --timeout=10m
          kubectl rollout status deployment/airbyte-worker -n airbyte --timeout=10m
      
      - name: Deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n airbyte
          echo ""
          echo "=== Services ==="
          kubectl get svc -n airbyte
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n airbyte
          echo ""
          echo "=== SSL Certificates ==="
          kubectl get managedcertificate -n airbyte
      
      - name: Run smoke tests
        run: |
          echo "‚è≥ Waiting for ingress to be ready..."
          sleep 30
          echo "üß™ Smoke tests would run here"
      
      - name: Summary
        run: |
          echo "‚úÖ Connectors Platform deployed to Production!"
          echo ""
          echo "üåê URLs:"
          echo "  Platform UI: https://connectors.aitronos.com"
          echo "  API Endpoint: https://connectors-api.aitronos.com"
          echo "  Direct IP: http://35.201.104.8"

